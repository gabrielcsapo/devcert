"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs_1 = require("fs");
const mkdirp_1 = require("mkdirp");
const lodash_1 = require("lodash");
const eol = require("eol");
const utils_1 = require("./utils");
const applicationConfigPath = require("application-config-path");
const _createDebug = require("debug");
const debug = _createDebug('devcert:constants');
// Platform shortcuts
exports.isMac = process.platform === 'darwin';
exports.isLinux = process.platform === 'linux';
exports.isWindows = process.platform === 'win32';
// Common paths
exports.configDir = applicationConfigPath('devcert');
exports.configPath = path.join.bind(path, exports.configDir);
exports.DEFAULT_REMOTE_PORT = 2702;
exports.domainsDir = exports.configPath('domains');
exports.caVersionFile = exports.configPath('devcert-ca-version');
exports.opensslSerialFilePath = exports.configPath('certificate-authority', 'serial');
exports.opensslDatabaseFilePath = exports.configPath('certificate-authority', 'index.txt');
exports.caSelfSignConfig = path.join(__dirname, '../../openssl-configurations/certificate-authority-self-signing.conf');
function includeWildcards(list) {
    return list.reduce((outlist, item) => {
        outlist.push(item, `*.${item}`);
        return outlist;
    }, []);
}
async function withDomainSigningRequestConfig(commonName, { alternativeNames }, cb) {
    const tmp = utils_1.tmpDir();
    const tmpFile = path.join(tmp.name, 'domain-certificate-signing-requests.conf');
    const source = fs_1.readFileSync(path.join(__dirname, '../../openssl-configurations/domain-certificate-signing-requests.conf'), 'utf-8');
    const template = lodash_1.template(source);
    const result = template({
        commonName,
        altNames: includeWildcards([commonName, ...alternativeNames])
    });
    fs_1.writeFileSync(tmpFile, eol.auto(result));
    await cb(tmpFile);
    fs_1.unlinkSync(tmpFile);
    tmp.removeCallback();
}
exports.withDomainSigningRequestConfig = withDomainSigningRequestConfig;
async function withDomainCertificateConfig(commonName, alternativeNames, cb) {
    const tmp = utils_1.tmpDir();
    const tmpFile = path.join(tmp.name, 'ca.cfg');
    const source = fs_1.readFileSync(path.join(__dirname, '../../openssl-configurations/domain-certificates.conf'), 'utf-8');
    const template = lodash_1.template(source);
    const result = template({
        commonName,
        altNames: includeWildcards([commonName, ...alternativeNames]),
        serialFile: exports.opensslSerialFilePath,
        databaseFile: exports.opensslDatabaseFilePath,
        domainDir: utils_1.pathForDomain(commonName)
    });
    fs_1.writeFileSync(tmpFile, eol.auto(result));
    await cb(tmpFile);
    fs_1.unlinkSync(tmpFile);
    tmp.removeCallback();
}
exports.withDomainCertificateConfig = withDomainCertificateConfig;
// confTemplate = confTemplate.replace(/DATABASE_PATH/, configPath('index.txt').replace(/\\/g, '\\\\'));
// confTemplate = confTemplate.replace(/SERIAL_PATH/, configPath('serial').replace(/\\/g, '\\\\'));
// confTemplate = eol.auto(confTemplate);
exports.rootCADir = exports.configPath('certificate-authority');
exports.rootCAKeyPath = path.join(exports.rootCADir, 'private-key.key');
exports.rootCACertPath = path.join(exports.rootCADir, 'certificate.cert');
debug('rootCACertPath', exports.rootCACertPath);
debug('rootCAKeyPath', exports.rootCAKeyPath);
debug('rootCADir', exports.rootCADir);
// Exposed for uninstallation purposes.
function getLegacyConfigDir() {
    if (exports.isWindows && process.env.LOCALAPPDATA) {
        return path.join(process.env.LOCALAPPDATA, 'devcert', 'config');
    }
    else {
        const uid = process.getuid && process.getuid();
        const userHome = exports.isLinux && uid === 0
            ? path.resolve('/usr/local/share')
            : require('os').homedir();
        return path.join(userHome, '.config', 'devcert');
    }
}
exports.getLegacyConfigDir = getLegacyConfigDir;
function ensureConfigDirs() {
    mkdirp_1.sync(exports.configDir);
    mkdirp_1.sync(exports.domainsDir);
    mkdirp_1.sync(exports.rootCADir);
}
exports.ensureConfigDirs = ensureConfigDirs;
ensureConfigDirs();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RhbnRzLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzcmMvY29uc3RhbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLDJCQUlZO0FBQ1osbUNBQXdDO0FBQ3hDLG1DQUFrRDtBQUNsRCwyQkFBMkI7QUFDM0IsbUNBQWdEO0FBQ2hELGlFQUFrRTtBQUNsRSxzQ0FBc0M7QUFFdEMsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDaEQscUJBQXFCO0FBQ1IsUUFBQSxLQUFLLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQUM7QUFDdEMsUUFBQSxPQUFPLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUM7QUFDdkMsUUFBQSxTQUFTLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUM7QUFFdEQsZUFBZTtBQUNGLFFBQUEsU0FBUyxHQUFHLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzdDLFFBQUEsVUFBVSxHQUEwQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDN0UsSUFBSSxFQUNKLGlCQUFTLENBQ1YsQ0FBQztBQUVXLFFBQUEsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO0FBRTNCLFFBQUEsVUFBVSxHQUFHLGtCQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFbkMsUUFBQSxhQUFhLEdBQUcsa0JBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ2pELFFBQUEscUJBQXFCLEdBQUcsa0JBQVUsQ0FDN0MsdUJBQXVCLEVBQ3ZCLFFBQVEsQ0FDVCxDQUFDO0FBQ1csUUFBQSx1QkFBdUIsR0FBRyxrQkFBVSxDQUMvQyx1QkFBdUIsRUFDdkIsV0FBVyxDQUNaLENBQUM7QUFDVyxRQUFBLGdCQUFnQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQ3ZDLFNBQVMsRUFDVCxzRUFBc0UsQ0FDdkUsQ0FBQztBQUVGLFNBQVMsZ0JBQWdC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QUMsQ0FBQztBQUN4QyxLQUFLLENBQUMsZUFBZSxFQUFFLHFCQUFhLENBQUMsQ0FBQztBQUN0QyxLQUFLLENBQUMsV0FBVyxFQUFFLGlCQUFTLENBQUMsQ0FBQztBQUU5Qix1Q0FBdUM7QUFDdkMsU0FBZ0Isa0JBQWtCO0lBQ2hDLElBQUksaUJBQVMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtRQUN6QyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ2pFO1NBQU07UUFDTCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMvQyxNQUFNLFFBQVEsR0FDWixlQUFPLElBQUksR0FBRyxLQUFLLENBQUM7WUFDbEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUM7WUFDbEMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztLQUNsRDtBQUNILENBQUM7QUFYRCxnREFXQztBQUVELFNBQWdCLGdCQUFnQjtJQUM5QixhQUFNLENBQUMsaUJBQVMsQ0FBQyxDQUFDO0lBQ2xCLGFBQU0sQ0FBQyxrQkFBVSxDQUFDLENBQUM7SUFDbkIsYUFBTSxDQUFDLGlCQUFTLENBQUMsQ0FBQztBQUNwQixDQUFDO0FBSkQsNENBSUM7QUFFRCxnQkFBZ0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7XG4gIHdyaXRlRmlsZVN5bmMgYXMgd3JpdGVGaWxlLFxuICByZWFkRmlsZVN5bmMgYXMgcmVhZEZpbGUsXG4gIHVubGlua1N5bmNcbn0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgc3luYyBhcyBta2RpcnAgfSBmcm9tICdta2RpcnAnO1xuaW1wb3J0IHsgdGVtcGxhdGUgYXMgbWFrZVRlbXBsYXRlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGVvbCBmcm9tICdlb2wnO1xuaW1wb3J0IHsgdG1wRGlyLCBwYXRoRm9yRG9tYWluIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgYXBwbGljYXRpb25Db25maWdQYXRoID0gcmVxdWlyZSgnYXBwbGljYXRpb24tY29uZmlnLXBhdGgnKTtcbmltcG9ydCAqIGFzIF9jcmVhdGVEZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmNvbnN0IGRlYnVnID0gX2NyZWF0ZURlYnVnKCdkZXZjZXJ0OmNvbnN0YW50cycpO1xuLy8gUGxhdGZvcm0gc2hvcnRjdXRzXG5leHBvcnQgY29uc3QgaXNNYWMgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnZGFyd2luJztcbmV4cG9ydCBjb25zdCBpc0xpbnV4ID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2xpbnV4JztcbmV4cG9ydCBjb25zdCBpc1dpbmRvd3MgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInO1xuXG4vLyBDb21tb24gcGF0aHNcbmV4cG9ydCBjb25zdCBjb25maWdEaXIgPSBhcHBsaWNhdGlvbkNvbmZpZ1BhdGgoJ2RldmNlcnQnKTtcbmV4cG9ydCBjb25zdCBjb25maWdQYXRoOiAoLi4ucGF0aFNlZ21lbnRzOiBzdHJpbmdbXSkgPT4gc3RyaW5nID0gcGF0aC5qb2luLmJpbmQoXG4gIHBhdGgsXG4gIGNvbmZpZ0RpclxuKTtcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfUkVNT1RFX1BPUlQgPSAyNzAyO1xuXG5leHBvcnQgY29uc3QgZG9tYWluc0RpciA9IGNvbmZpZ1BhdGgoJ2RvbWFpbnMnKTtcblxuZXhwb3J0IGNvbnN0IGNhVmVyc2lvbkZpbGUgPSBjb25maWdQYXRoKCdkZXZjZXJ0LWNhLXZlcnNpb24nKTtcbmV4cG9ydCBjb25zdCBvcGVuc3NsU2VyaWFsRmlsZVBhdGggPSBjb25maWdQYXRoKFxuICAnY2VydGlmaWNhdGUtYXV0aG9yaXR5JyxcbiAgJ3NlcmlhbCdcbik7XG5leHBvcnQgY29uc3Qgb3BlbnNzbERhdGFiYXNlRmlsZVBhdGggPSBjb25maWdQYXRoKFxuICAnY2VydGlmaWNhdGUtYXV0aG9yaXR5JyxcbiAgJ2luZGV4LnR4dCdcbik7XG5leHBvcnQgY29uc3QgY2FTZWxmU2lnbkNvbmZpZyA9IHBhdGguam9pbihcbiAgX19kaXJuYW1lLFxuICAnLi4vLi4vb3BlbnNzbC1jb25maWd1cmF0aW9ucy9jZXJ0aWZpY2F0ZS1hdXRob3JpdHktc2VsZi1zaWduaW5nLmNvbmYnXG4pO1xuXG5mdW5jdGlvbiBpbmNsdWRlV2lsZGNhcmRzKGxpc3Q6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICByZXR1cm4gbGlzdC5yZWR1Y2UoKG91dGxpc3QsIGl0ZW0pID0+IHtcbiAgICBvdXRsaXN0LnB1c2goaXRlbSwgYCouJHtpdGVtfWApO1xuICAgIHJldHVybiBvdXRsaXN0O1xuICB9LCBbXSBhcyBzdHJpbmdbXSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoRG9tYWluU2lnbmluZ1JlcXVlc3RDb25maWcoXG4gIGNvbW1vbk5hbWU6IHN0cmluZyxcbiAgeyBhbHRlcm5hdGl2ZU5hbWVzIH06IHsgYWx0ZXJuYXRpdmVOYW1lczogc3RyaW5nW10gfSxcbiAgY2I6IChmaWxlcGF0aDogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+IHwgdm9pZFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHRtcCA9IHRtcERpcigpO1xuICBjb25zdCB0bXBGaWxlID0gcGF0aC5qb2luKFxuICAgIHRtcC5uYW1lLFxuICAgICdkb21haW4tY2VydGlmaWNhdGUtc2lnbmluZy1yZXF1ZXN0cy5jb25mJ1xuICApO1xuICBjb25zdCBzb3VyY2UgPSByZWFkRmlsZShcbiAgICBwYXRoLmpvaW4oXG4gICAgICBfX2Rpcm5hbWUsXG4gICAgICAnLi4vLi4vb3BlbnNzbC1jb25maWd1cmF0aW9ucy9kb21haW4tY2VydGlmaWNhdGUtc2lnbmluZy1yZXF1ZXN0cy5jb25mJ1xuICAgICksXG4gICAgJ3V0Zi04J1xuICApO1xuICBjb25zdCB0ZW1wbGF0ZSA9IG1ha2VUZW1wbGF0ZShzb3VyY2UpO1xuICBjb25zdCByZXN1bHQgPSB0ZW1wbGF0ZSh7XG4gICAgY29tbW9uTmFtZSxcbiAgICBhbHROYW1lczogaW5jbHVkZVdpbGRjYXJkcyhbY29tbW9uTmFtZSwgLi4uYWx0ZXJuYXRpdmVOYW1lc10pXG4gIH0pO1xuICB3cml0ZUZpbGUodG1wRmlsZSwgZW9sLmF1dG8ocmVzdWx0KSk7XG4gIGF3YWl0IGNiKHRtcEZpbGUpO1xuICB1bmxpbmtTeW5jKHRtcEZpbGUpO1xuICB0bXAucmVtb3ZlQ2FsbGJhY2soKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdpdGhEb21haW5DZXJ0aWZpY2F0ZUNvbmZpZyhcbiAgY29tbW9uTmFtZTogc3RyaW5nLFxuICBhbHRlcm5hdGl2ZU5hbWVzOiBzdHJpbmdbXSxcbiAgY2I6IChmaWxlcGF0aDogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+IHwgdm9pZFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHRtcCA9IHRtcERpcigpO1xuICBjb25zdCB0bXBGaWxlID0gcGF0aC5qb2luKHRtcC5uYW1lLCAnY2EuY2ZnJyk7XG4gIGNvbnN0IHNvdXJjZSA9IHJlYWRGaWxlKFxuICAgIHBhdGguam9pbihcbiAgICAgIF9fZGlybmFtZSxcbiAgICAgICcuLi8uLi9vcGVuc3NsLWNvbmZpZ3VyYXRpb25zL2RvbWFpbi1jZXJ0aWZpY2F0ZXMuY29uZidcbiAgICApLFxuICAgICd1dGYtOCdcbiAgKTtcbiAgY29uc3QgdGVtcGxhdGUgPSBtYWtlVGVtcGxhdGUoc291cmNlKTtcbiAgY29uc3QgcmVzdWx0ID0gdGVtcGxhdGUoe1xuICAgIGNvbW1vbk5hbWUsXG4gICAgYWx0TmFtZXM6IGluY2x1ZGVXaWxkY2FyZHMoW2NvbW1vbk5hbWUsIC4uLmFsdGVybmF0aXZlTmFtZXNdKSxcbiAgICBzZXJpYWxGaWxlOiBvcGVuc3NsU2VyaWFsRmlsZVBhdGgsXG4gICAgZGF0YWJhc2VGaWxlOiBvcGVuc3NsRGF0YWJhc2VGaWxlUGF0aCxcbiAgICBkb21haW5EaXI6IHBhdGhGb3JEb21haW4oY29tbW9uTmFtZSlcbiAgfSk7XG4gIHdyaXRlRmlsZSh0bXBGaWxlLCBlb2wuYXV0byhyZXN1bHQpKTtcbiAgYXdhaXQgY2IodG1wRmlsZSk7XG4gIHVubGlua1N5bmModG1wRmlsZSk7XG4gIHRtcC5yZW1vdmVDYWxsYmFjaygpO1xufVxuXG4vLyBjb25mVGVtcGxhdGUgPSBjb25mVGVtcGxhdGUucmVwbGFjZSgvREFUQUJBU0VfUEFUSC8sIGNvbmZpZ1BhdGgoJ2luZGV4LnR4dCcpLnJlcGxhY2UoL1xcXFwvZywgJ1xcXFxcXFxcJykpO1xuLy8gY29uZlRlbXBsYXRlID0gY29uZlRlbXBsYXRlLnJlcGxhY2UoL1NFUklBTF9QQVRILywgY29uZmlnUGF0aCgnc2VyaWFsJykucmVwbGFjZSgvXFxcXC9nLCAnXFxcXFxcXFwnKSk7XG4vLyBjb25mVGVtcGxhdGUgPSBlb2wuYXV0byhjb25mVGVtcGxhdGUpO1xuXG5leHBvcnQgY29uc3Qgcm9vdENBRGlyID0gY29uZmlnUGF0aCgnY2VydGlmaWNhdGUtYXV0aG9yaXR5Jyk7XG5leHBvcnQgY29uc3Qgcm9vdENBS2V5UGF0aCA9IHBhdGguam9pbihyb290Q0FEaXIsICdwcml2YXRlLWtleS5rZXknKTtcbmV4cG9ydCBjb25zdCByb290Q0FDZXJ0UGF0aCA9IHBhdGguam9pbihyb290Q0FEaXIsICdjZXJ0aWZpY2F0ZS5jZXJ0Jyk7XG5cbmRlYnVnKCdyb290Q0FDZXJ0UGF0aCcsIHJvb3RDQUNlcnRQYXRoKTtcbmRlYnVnKCdyb290Q0FLZXlQYXRoJywgcm9vdENBS2V5UGF0aCk7XG5kZWJ1Zygncm9vdENBRGlyJywgcm9vdENBRGlyKTtcblxuLy8gRXhwb3NlZCBmb3IgdW5pbnN0YWxsYXRpb24gcHVycG9zZXMuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TGVnYWN5Q29uZmlnRGlyKCk6IHN0cmluZyB7XG4gIGlmIChpc1dpbmRvd3MgJiYgcHJvY2Vzcy5lbnYuTE9DQUxBUFBEQVRBKSB7XG4gICAgcmV0dXJuIHBhdGguam9pbihwcm9jZXNzLmVudi5MT0NBTEFQUERBVEEsICdkZXZjZXJ0JywgJ2NvbmZpZycpO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHVpZCA9IHByb2Nlc3MuZ2V0dWlkICYmIHByb2Nlc3MuZ2V0dWlkKCk7XG4gICAgY29uc3QgdXNlckhvbWUgPVxuICAgICAgaXNMaW51eCAmJiB1aWQgPT09IDBcbiAgICAgICAgPyBwYXRoLnJlc29sdmUoJy91c3IvbG9jYWwvc2hhcmUnKVxuICAgICAgICA6IHJlcXVpcmUoJ29zJykuaG9tZWRpcigpO1xuICAgIHJldHVybiBwYXRoLmpvaW4odXNlckhvbWUsICcuY29uZmlnJywgJ2RldmNlcnQnKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZW5zdXJlQ29uZmlnRGlycygpOiB2b2lkIHtcbiAgbWtkaXJwKGNvbmZpZ0Rpcik7XG4gIG1rZGlycChkb21haW5zRGlyKTtcbiAgbWtkaXJwKHJvb3RDQURpcik7XG59XG5cbmVuc3VyZUNvbmZpZ0RpcnMoKTtcbiJdfQ==