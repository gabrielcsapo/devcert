"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs_1 = require("fs");
const mkdirp_1 = require("mkdirp");
const lodash_1 = require("lodash");
const eol = require("eol");
const utils_1 = require("./utils");
const applicationConfigPath = require("application-config-path");
const _createDebug = require("debug");
const debug = _createDebug('devcert:constants');
// Platform shortcuts
exports.isMac = process.platform === 'darwin';
exports.isLinux = process.platform === 'linux';
exports.isWindows = process.platform === 'win32';
// Common paths
exports.configDir = applicationConfigPath('devcert');
exports.configPath = path.join.bind(path, exports.configDir);
exports.domainsDir = exports.configPath('domains');
exports.caVersionFile = exports.configPath('devcert-ca-version');
exports.opensslSerialFilePath = exports.configPath('certificate-authority', 'serial');
exports.opensslDatabaseFilePath = exports.configPath('certificate-authority', 'index.txt');
exports.caSelfSignConfig = path.join(__dirname, '../openssl-configurations/certificate-authority-self-signing.conf');
function includeWildcards(list) {
    return list.reduce((outlist, item) => {
        outlist.push(item, `*.${item}`);
        return outlist;
    }, []);
}
async function withDomainSigningRequestConfig(commonName, { alternativeNames }, cb) {
    const tmp = utils_1.tmpDir();
    const tmpFile = path.join(tmp.name, 'domain-certificate-signing-requests.conf');
    const source = fs_1.readFileSync(path.join(__dirname, '../openssl-configurations/domain-certificate-signing-requests.conf'), 'utf-8');
    const template = lodash_1.template(source);
    const result = template({
        commonName,
        altNames: includeWildcards([commonName, ...alternativeNames])
    });
    fs_1.writeFileSync(tmpFile, eol.auto(result));
    await cb(tmpFile);
    fs_1.unlinkSync(tmpFile);
    tmp.removeCallback();
}
exports.withDomainSigningRequestConfig = withDomainSigningRequestConfig;
async function withDomainCertificateConfig(commonName, alternativeNames, cb) {
    const tmp = utils_1.tmpDir();
    const tmpFile = path.join(tmp.name, 'ca.cfg');
    const source = fs_1.readFileSync(path.join(__dirname, '../openssl-configurations/domain-certificates.conf'), 'utf-8');
    const template = lodash_1.template(source);
    const result = template({
        commonName,
        altNames: includeWildcards([commonName, ...alternativeNames]),
        serialFile: exports.opensslSerialFilePath,
        databaseFile: exports.opensslDatabaseFilePath,
        domainDir: utils_1.pathForDomain(commonName)
    });
    fs_1.writeFileSync(tmpFile, eol.auto(result));
    await cb(tmpFile);
    fs_1.unlinkSync(tmpFile);
    tmp.removeCallback();
}
exports.withDomainCertificateConfig = withDomainCertificateConfig;
// confTemplate = confTemplate.replace(/DATABASE_PATH/, configPath('index.txt').replace(/\\/g, '\\\\'));
// confTemplate = confTemplate.replace(/SERIAL_PATH/, configPath('serial').replace(/\\/g, '\\\\'));
// confTemplate = eol.auto(confTemplate);
exports.rootCADir = exports.configPath('certificate-authority');
exports.rootCAKeyPath = path.join(exports.rootCADir, 'private-key.key');
exports.rootCACertPath = path.join(exports.rootCADir, 'certificate.cert');
debug('rootCACertPath', exports.rootCACertPath);
debug('rootCAKeyPath', exports.rootCAKeyPath);
debug('rootCADir', exports.rootCADir);
// Exposed for uninstallation purposes.
function getLegacyConfigDir() {
    if (exports.isWindows && process.env.LOCALAPPDATA) {
        return path.join(process.env.LOCALAPPDATA, 'devcert', 'config');
    }
    else {
        const uid = process.getuid && process.getuid();
        const userHome = exports.isLinux && uid === 0
            ? path.resolve('/usr/local/share')
            : require('os').homedir();
        return path.join(userHome, '.config', 'devcert');
    }
}
exports.getLegacyConfigDir = getLegacyConfigDir;
function ensureConfigDirs() {
    mkdirp_1.sync(exports.configDir);
    mkdirp_1.sync(exports.domainsDir);
    mkdirp_1.sync(exports.rootCADir);
}
exports.ensureConfigDirs = ensureConfigDirs;
ensureConfigDirs();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RhbnRzLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzcmMvY29uc3RhbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLDJCQUlZO0FBQ1osbUNBQXdDO0FBQ3hDLG1DQUFrRDtBQUNsRCwyQkFBMkI7QUFDM0IsbUNBQWdEO0FBQ2hELGlFQUFrRTtBQUNsRSxzQ0FBc0M7QUFFdEMsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDaEQscUJBQXFCO0FBQ1IsUUFBQSxLQUFLLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQUM7QUFDdEMsUUFBQSxPQUFPLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUM7QUFDdkMsUUFBQSxTQUFTLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUM7QUFFdEQsZUFBZTtBQUNGLFFBQUEsU0FBUyxHQUFHLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzdDLFFBQUEsVUFBVSxHQUEwQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDN0UsSUFBSSxFQUNKLGlCQUFTLENBQ1YsQ0FBQztBQUVXLFFBQUEsVUFBVSxHQUFHLGtCQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFbkMsUUFBQSxhQUFhLEdBQUcsa0JBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ2pELFFBQUEscUJBQXFCLEdBQUcsa0JBQVUsQ0FDN0MsdUJBQXVCLEVBQ3ZCLFFBQVEsQ0FDVCxDQUFDO0FBQ1csUUFBQSx1QkFBdUIsR0FBRyxrQkFBVSxDQUMvQyx1QkFBdUIsRUFDdkIsV0FBVyxDQUNaLENBQUM7QUFDVyxRQUFBLGdCQUFnQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQ3ZDLFNBQVMsRUFDVCxtRUFBbUUsQ0FDcEUsQ0FBQztBQUVGLFNBQVMsZ0JBQWdCLENBQUMsSUFBYztJQUN0QyxPQUFPLElBQUksQ0FBQyxN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LHFCQUFhLENBQUMsQ0FBQztBQUN0QyxLQUFLLENBQUMsV0FBVyxFQUFFLGlCQUFTLENBQUMsQ0FBQztBQUU5Qix1Q0FBdUM7QUFDdkMsU0FBZ0Isa0JBQWtCO0lBQ2hDLElBQUksaUJBQVMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtRQUN6QyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ2pFO1NBQU07UUFDTCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMvQyxNQUFNLFFBQVEsR0FDWixlQUFPLElBQUksR0FBRyxLQUFLLENBQUM7WUFDbEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUM7WUFDbEMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztLQUNsRDtBQUNILENBQUM7QUFYRCxnREFXQztBQUVELFNBQWdCLGdCQUFnQjtJQUM5QixhQUFNLENBQUMsaUJBQVMsQ0FBQyxDQUFDO0lBQ2xCLGFBQU0sQ0FBQyxrQkFBVSxDQUFDLENBQUM7SUFDbkIsYUFBTSxDQUFDLGlCQUFTLENBQUMsQ0FBQztBQUNwQixDQUFDO0FBSkQsNENBSUM7QUFFRCxnQkFBZ0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7XG4gIHdyaXRlRmlsZVN5bmMgYXMgd3JpdGVGaWxlLFxuICByZWFkRmlsZVN5bmMgYXMgcmVhZEZpbGUsXG4gIHVubGlua1N5bmNcbn0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgc3luYyBhcyBta2RpcnAgfSBmcm9tICdta2RpcnAnO1xuaW1wb3J0IHsgdGVtcGxhdGUgYXMgbWFrZVRlbXBsYXRlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGVvbCBmcm9tICdlb2wnO1xuaW1wb3J0IHsgdG1wRGlyLCBwYXRoRm9yRG9tYWluIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgYXBwbGljYXRpb25Db25maWdQYXRoID0gcmVxdWlyZSgnYXBwbGljYXRpb24tY29uZmlnLXBhdGgnKTtcbmltcG9ydCAqIGFzIF9jcmVhdGVEZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmNvbnN0IGRlYnVnID0gX2NyZWF0ZURlYnVnKCdkZXZjZXJ0OmNvbnN0YW50cycpO1xuLy8gUGxhdGZvcm0gc2hvcnRjdXRzXG5leHBvcnQgY29uc3QgaXNNYWMgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnZGFyd2luJztcbmV4cG9ydCBjb25zdCBpc0xpbnV4ID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2xpbnV4JztcbmV4cG9ydCBjb25zdCBpc1dpbmRvd3MgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInO1xuXG4vLyBDb21tb24gcGF0aHNcbmV4cG9ydCBjb25zdCBjb25maWdEaXIgPSBhcHBsaWNhdGlvbkNvbmZpZ1BhdGgoJ2RldmNlcnQnKTtcbmV4cG9ydCBjb25zdCBjb25maWdQYXRoOiAoLi4ucGF0aFNlZ21lbnRzOiBzdHJpbmdbXSkgPT4gc3RyaW5nID0gcGF0aC5qb2luLmJpbmQoXG4gIHBhdGgsXG4gIGNvbmZpZ0RpclxuKTtcblxuZXhwb3J0IGNvbnN0IGRvbWFpbnNEaXIgPSBjb25maWdQYXRoKCdkb21haW5zJyk7XG5cbmV4cG9ydCBjb25zdCBjYVZlcnNpb25GaWxlID0gY29uZmlnUGF0aCgnZGV2Y2VydC1jYS12ZXJzaW9uJyk7XG5leHBvcnQgY29uc3Qgb3BlbnNzbFNlcmlhbEZpbGVQYXRoID0gY29uZmlnUGF0aChcbiAgJ2NlcnRpZmljYXRlLWF1dGhvcml0eScsXG4gICdzZXJpYWwnXG4pO1xuZXhwb3J0IGNvbnN0IG9wZW5zc2xEYXRhYmFzZUZpbGVQYXRoID0gY29uZmlnUGF0aChcbiAgJ2NlcnRpZmljYXRlLWF1dGhvcml0eScsXG4gICdpbmRleC50eHQnXG4pO1xuZXhwb3J0IGNvbnN0IGNhU2VsZlNpZ25Db25maWcgPSBwYXRoLmpvaW4oXG4gIF9fZGlybmFtZSxcbiAgJy4uL29wZW5zc2wtY29uZmlndXJhdGlvbnMvY2VydGlmaWNhdGUtYXV0aG9yaXR5LXNlbGYtc2lnbmluZy5jb25mJ1xuKTtcblxuZnVuY3Rpb24gaW5jbHVkZVdpbGRjYXJkcyhsaXN0OiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIGxpc3QucmVkdWNlKChvdXRsaXN0LCBpdGVtKSA9PiB7XG4gICAgb3V0bGlzdC5wdXNoKGl0ZW0sIGAqLiR7aXRlbX1gKTtcbiAgICByZXR1cm4gb3V0bGlzdDtcbiAgfSwgW10gYXMgc3RyaW5nW10pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2l0aERvbWFpblNpZ25pbmdSZXF1ZXN0Q29uZmlnKFxuICBjb21tb25OYW1lOiBzdHJpbmcsXG4gIHsgYWx0ZXJuYXRpdmVOYW1lcyB9OiB7IGFsdGVybmF0aXZlTmFtZXM6IHN0cmluZ1tdIH0sXG4gIGNiOiAoZmlsZXBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiB8IHZvaWRcbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCB0bXAgPSB0bXBEaXIoKTtcbiAgY29uc3QgdG1wRmlsZSA9IHBhdGguam9pbihcbiAgICB0bXAubmFtZSxcbiAgICAnZG9tYWluLWNlcnRpZmljYXRlLXNpZ25pbmctcmVxdWVzdHMuY29uZidcbiAgKTtcbiAgY29uc3Qgc291cmNlID0gcmVhZEZpbGUoXG4gICAgcGF0aC5qb2luKFxuICAgICAgX19kaXJuYW1lLFxuICAgICAgJy4uL29wZW5zc2wtY29uZmlndXJhdGlvbnMvZG9tYWluLWNlcnRpZmljYXRlLXNpZ25pbmctcmVxdWVzdHMuY29uZidcbiAgICApLFxuICAgICd1dGYtOCdcbiAgKTtcbiAgY29uc3QgdGVtcGxhdGUgPSBtYWtlVGVtcGxhdGUoc291cmNlKTtcbiAgY29uc3QgcmVzdWx0ID0gdGVtcGxhdGUoe1xuICAgIGNvbW1vbk5hbWUsXG4gICAgYWx0TmFtZXM6IGluY2x1ZGVXaWxkY2FyZHMoW2NvbW1vbk5hbWUsIC4uLmFsdGVybmF0aXZlTmFtZXNdKVxuICB9KTtcbiAgd3JpdGVGaWxlKHRtcEZpbGUsIGVvbC5hdXRvKHJlc3VsdCkpO1xuICBhd2FpdCBjYih0bXBGaWxlKTtcbiAgdW5saW5rU3luYyh0bXBGaWxlKTtcbiAgdG1wLnJlbW92ZUNhbGxiYWNrKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoRG9tYWluQ2VydGlmaWNhdGVDb25maWcoXG4gIGNvbW1vbk5hbWU6IHN0cmluZyxcbiAgYWx0ZXJuYXRpdmVOYW1lczogc3RyaW5nW10sXG4gIGNiOiAoZmlsZXBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiB8IHZvaWRcbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCB0bXAgPSB0bXBEaXIoKTtcbiAgY29uc3QgdG1wRmlsZSA9IHBhdGguam9pbih0bXAubmFtZSwgJ2NhLmNmZycpO1xuICBjb25zdCBzb3VyY2UgPSByZWFkRmlsZShcbiAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vb3BlbnNzbC1jb25maWd1cmF0aW9ucy9kb21haW4tY2VydGlmaWNhdGVzLmNvbmYnKSxcbiAgICAndXRmLTgnXG4gICk7XG4gIGNvbnN0IHRlbXBsYXRlID0gbWFrZVRlbXBsYXRlKHNvdXJjZSk7XG4gIGNvbnN0IHJlc3VsdCA9IHRlbXBsYXRlKHtcbiAgICBjb21tb25OYW1lLFxuICAgIGFsdE5hbWVzOiBpbmNsdWRlV2lsZGNhcmRzKFtjb21tb25OYW1lLCAuLi5hbHRlcm5hdGl2ZU5hbWVzXSksXG4gICAgc2VyaWFsRmlsZTogb3BlbnNzbFNlcmlhbEZpbGVQYXRoLFxuICAgIGRhdGFiYXNlRmlsZTogb3BlbnNzbERhdGFiYXNlRmlsZVBhdGgsXG4gICAgZG9tYWluRGlyOiBwYXRoRm9yRG9tYWluKGNvbW1vbk5hbWUpXG4gIH0pO1xuICB3cml0ZUZpbGUodG1wRmlsZSwgZW9sLmF1dG8ocmVzdWx0KSk7XG4gIGF3YWl0IGNiKHRtcEZpbGUpO1xuICB1bmxpbmtTeW5jKHRtcEZpbGUpO1xuICB0bXAucmVtb3ZlQ2FsbGJhY2soKTtcbn1cblxuLy8gY29uZlRlbXBsYXRlID0gY29uZlRlbXBsYXRlLnJlcGxhY2UoL0RBVEFCQVNFX1BBVEgvLCBjb25maWdQYXRoKCdpbmRleC50eHQnKS5yZXBsYWNlKC9cXFxcL2csICdcXFxcXFxcXCcpKTtcbi8vIGNvbmZUZW1wbGF0ZSA9IGNvbmZUZW1wbGF0ZS5yZXBsYWNlKC9TRVJJQUxfUEFUSC8sIGNvbmZpZ1BhdGgoJ3NlcmlhbCcpLnJlcGxhY2UoL1xcXFwvZywgJ1xcXFxcXFxcJykpO1xuLy8gY29uZlRlbXBsYXRlID0gZW9sLmF1dG8oY29uZlRlbXBsYXRlKTtcblxuZXhwb3J0IGNvbnN0IHJvb3RDQURpciA9IGNvbmZpZ1BhdGgoJ2NlcnRpZmljYXRlLWF1dGhvcml0eScpO1xuZXhwb3J0IGNvbnN0IHJvb3RDQUtleVBhdGggPSBwYXRoLmpvaW4ocm9vdENBRGlyLCAncHJpdmF0ZS1rZXkua2V5Jyk7XG5leHBvcnQgY29uc3Qgcm9vdENBQ2VydFBhdGggPSBwYXRoLmpvaW4ocm9vdENBRGlyLCAnY2VydGlmaWNhdGUuY2VydCcpO1xuXG5kZWJ1Zygncm9vdENBQ2VydFBhdGgnLCByb290Q0FDZXJ0UGF0aCk7XG5kZWJ1Zygncm9vdENBS2V5UGF0aCcsIHJvb3RDQUtleVBhdGgpO1xuZGVidWcoJ3Jvb3RDQURpcicsIHJvb3RDQURpcik7XG5cbi8vIEV4cG9zZWQgZm9yIHVuaW5zdGFsbGF0aW9uIHB1cnBvc2VzLlxuZXhwb3J0IGZ1bmN0aW9uIGdldExlZ2FjeUNvbmZpZ0RpcigpOiBzdHJpbmcge1xuICBpZiAoaXNXaW5kb3dzICYmIHByb2Nlc3MuZW52LkxPQ0FMQVBQREFUQSkge1xuICAgIHJldHVybiBwYXRoLmpvaW4ocHJvY2Vzcy5lbnYuTE9DQUxBUFBEQVRBLCAnZGV2Y2VydCcsICdjb25maWcnKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCB1aWQgPSBwcm9jZXNzLmdldHVpZCAmJiBwcm9jZXNzLmdldHVpZCgpO1xuICAgIGNvbnN0IHVzZXJIb21lID1cbiAgICAgIGlzTGludXggJiYgdWlkID09PSAwXG4gICAgICAgID8gcGF0aC5yZXNvbHZlKCcvdXNyL2xvY2FsL3NoYXJlJylcbiAgICAgICAgOiByZXF1aXJlKCdvcycpLmhvbWVkaXIoKTtcbiAgICByZXR1cm4gcGF0aC5qb2luKHVzZXJIb21lLCAnLmNvbmZpZycsICdkZXZjZXJ0Jyk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZUNvbmZpZ0RpcnMoKTogdm9pZCB7XG4gIG1rZGlycChjb25maWdEaXIpO1xuICBta2RpcnAoZG9tYWluc0Rpcik7XG4gIG1rZGlycChyb290Q0FEaXIpO1xufVxuXG5lbnN1cmVDb25maWdEaXJzKCk7XG4iXX0=